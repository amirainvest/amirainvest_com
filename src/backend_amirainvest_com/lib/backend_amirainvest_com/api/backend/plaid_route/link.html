<html>
<head>
</head>
<body>

<div id="plaid">
    <div>
        <button id="link-initialize">Link To Plaid</button>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script type="text/javascript">
    (function ($) {
        const onSuccessRender = (public_token) => {
            const urlParams = new URLSearchParams(window.location.search)
            const amiraUserId = urlParams.get('user_id');
            $.post(`/plaid/link?user_id=${amiraUserId}`, {
                public_token: public_token,
            }, function () {
                alert("Successfully Added Account... Ingesting....")
            });
        }

        const handler = Plaid.create({
            token: '{{link_token}}',
            onSuccess: function (public_token, metadata) {
                // Send the public_token to your app server.
                // The metadata object contains info about the institution the
                // user selected and the account ID or IDs, if the
                // Select Account view is enabled.
                onSuccessRender(public_token)
            },
            onExit: function (err, metadata) {
                // The user exited the Link flow.
                if (err != null) {
                    // The user encountered a Plaid API error prior to exiting.
                }
                // metadata contains information about the institution
                // that the user selected and the most recent API request IDs.
                // Storing this information can be helpful for support.
            }
        });

        $('#link-initialize').click(() => {
            handler.open();
        })
    })(jQuery);
</script>
</body>
</html>
